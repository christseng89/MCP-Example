# BPMN Advanced

好的 👍 我来把这段说明整理成一个 **BPMN 图创建的逐步方法总结（中文）**，适合入门理解：

---

## BPMN 图逐步创建方法（总结）

### 第一步：收集流程背景信息

* 在画第一个 BPMN 图形前，先考虑清楚流程的背景。
* 确定流程的 **名称**、**目标**、为什么要建模，以及相关说明。

### 第二步：识别订单流程参与者

* 思考流程的 **参与者（Participants）**。
* 判断建模的 **粒度**：

  * 是需要完整细节，还是只要展示参与者及其消息交互即可。

### 第三步：绘制主线（Happy Path）【案例】

* 从 **开始事件（Start Event）** 出发，记录流程如何流转。
* 列出 **关键步骤**，一般 5–7 个任务或子流程即可。
* 指明流程的 **预期结果**（即理想产出）。

### 第四步：订单流程补充细节

* 给每个步骤添加更多说明。
* 明确触发条件（Triggers）、任务类型（Tasks Types）、资源使用（如文档、系统）。
* 在图中可加入 **数据对象（Data Object）**、**数据存储（Data Store）** 等。

### 第五步：订单流程异常处理

* 用 **网关（Gateways）** 表示分支：如果不是“快乐路径”，会发生什么？
* 对于输入不符合预期时，明确处理方式。
* 可用 **中间事件（Intermediate Events）**，尤其是边界事件，表示异常触发。

### 第六步：订单流程子流程细化

* 如有需要，深入建模，使用 **子流程（Subprocesses）** 展示更低层级的细节。

---

✅ **一句话总结**：
BPMN 建模从 **背景信息 → 参与者 → Happy Path → 细节 → 异常 → 子流程** 逐步展开，先抓主线，再加细节与例外，逐层完善。

---

## BPMN 建模六步骤 📌 实际案例：网上书店订单流程（Online Bookstore Order Process）

### 第一步：收集订单流程背景信息

* **流程名称**：网上书店订单处理流程
* **流程目标**：客户下单后，保证书籍能够及时发货并完成结算
* **建模目的**：用来优化电商系统的后台流程，明确部门分工

---

### 第二步：识别流程参与者

* **客户（Customer）**
* **网上书店系统（Online Store System）**
* **仓库（Warehouse）**
* **物流公司（Logistics Provider）**

---

### 第三步：绘制主线（Happy Path）

1. **开始事件**：客户在网站下单
2. **任务1**：系统生成订单
3. **任务2**：系统向仓库发送拣货指令
4. **任务3**：仓库拣货、打包
5. **任务4**：仓库安排物流
6. **任务5**：物流公司配送
7. **任务6**：客户收到书籍
8. **结束事件**：订单完成

---

### 第四步：补充细节

* **触发器**：客户点击“下单”按钮触发流程
* **任务类型**：

  * 系统任务（自动化）：生成订单、发送指令
  * 人工任务：仓库拣货、物流配送
* **资源对象**：

  * 数据对象：订单信息、库存数据
  * 数据存储：ERP 系统、物流系统

---

### 第五步：处理例外情况

* **网关1**：库存不足？

  * 是 → 发送通知给客户，流程结束
  * 否 → 继续 Happy Path
* **边界事件**：若客户付款失败 → 流程取消

---

### 第六步：细化子流程

* **子流程：仓库拣货、打包**

  * 检查库存 → 拣货 → 包装 → 打印面单
* **子流程：物流配送**

  * 分配快递公司 → 运输 → 签收

---

✅ **总结**：
这个真实案例展示了一个网上书店订单处理的 **BPMN 流程图**建模思路：从背景信息、参与者，到 Happy Path，再到异常处理和子流程细化。

---

## 📌 Boundary Events 分类与实例

Boundary 事件通常附着在 **任务**/**子流程**边界 上，用来捕捉异常、超时、消息等情况。触发后会**中断**/**继续**/其他**改变**任务的执行流程。

### 1. Message Boundary Event（消息边界事件）

👉 等待接收一条外部消息，如果收到了就中断/继续其他路径。
📌 例子：

* 银行 → 在 **等待客户上传资料**任务上加一个消息边界事件，若收到了“资料补交”，则继续流程。

---

### 2. Timer Boundary Event（定时器边界事件）

👉 任务如果在规定时间内未完成，就触发边界事件。
📌 例子：

* 电商 → **等待客户付款**任务设置 24 小时定时边界事件，如果超时未付款 → 订单自动取消。

---

### 3. Escalation Boundary Event（升级边界事件）

👉 捕捉到“升级信号”时触发，常用于业务升级处理。
📌 例子：

* 客服处理客户投诉 → 如果超出权限，触发升级边界事件 → 转交给经理。

---

### 4. Conditional Boundary Event（条件边界事件）

👉 当某个业务条件满足时触发。
📌 例子：

* 银行贷款审批 → 在“风险评估”任务设置条件边界事件：如果客户信用评分 < 600 → 触发“人工复核”。

---

### 5. Error Boundary Event（错误边界事件）

👉 捕捉任务内部抛出的错误并触发异常处理。
📌 例子：

* 银行批量扣款 → 如果发生“账户不存在错误”，触发边界事件 → 记录失败日志并通知客户经理。

---

### 6. Signal Boundary Event（信号边界事件）

👉 等待广播信号（任何地方抛出信号都能捕获）。
📌 例子：

* 系统维护 → 抛出“系统停机”信号 → 所有带信号边界事件的任务都会立即中止并进入“待机”处理。

---

### 7. Compensation Boundary Event（补偿边界事件）

👉 捕捉补偿请求并触发补偿动作。
📌 例子：

* 电商 → 在“扣款”任务设置补偿边界事件，如果后续订单取消 → 执行“退款”补偿。

---

### 8. Non-interrupting Boundary Events（非中断边界事件）

👉 不会中断主任务，而是**并行启动另一条分支**。
📌 例子：

* 银行贷款审批 → 在“等待资料”任务上设置 **非中断定时边界事件**，到期时给客户发送提醒短信，但任务继续等待，不会被取消。

---

✅ **总结**：

* **Message / Timer** → 等消息 / 等时间
* **Escalation / Conditional** → 特殊业务条件
* **Error** → 捕捉错误
* **Signal** → 广播触发
* **Compensation** → 执行补偿
* **Non-interrupting** → 并行提醒，不影响主任务

---

## **Event-Based Gateway（事件型网关）** 是一种特殊的网关，用来表示：流程的下一步取决于 **哪个事件先发生**

### 📌 特点

* 与 **条件网关**（依据数据条件判断）不同，事件型网关是 **等待事件发生** 来决定路径。
* 它后面必须直接跟随一个或多个 **事件 (Event)**，例如消息事件、定时器事件、信号事件等。
* 当**一个**事件被触发，流程就会选择那条路径，**其它**等待的事件就会**被取消**。

---

### Event-Based Gateway 后面可以连接的事件类型

*1 消息事件（Message）
*2 定时器事件（Timer）
*3 信号事件（Signal）
*4 条件事件（Conditional）以及
*5 接收任务 (Receive Task)。

---

### 📖 中文真实案例

#### 例子 1：银行贷款申请

**场景**：贷款部门等待客户的进一步操作。

* **消息事件**：客户上传了所需的收入证明。
* **定时器事件**：客户 5 天内未上传任何资料。

👉 如果客户上传了 → 流程进入“继续审批”；
👉 如果超时 → 流程进入“申请失效”。

---

#### 例子 2：电商退货处理

**场景**：客户申请退货后，系统等待结果。

* **消息事件**：物流公司发来“退货商品已签收”的消息。
* **定时器事件**：7 天内未收到退货商品。

👉 如果签收 → 进入“退款流程”；
👉 如果超时 → 进入“关闭退货请求”。

---

#### 例子 3：IT 支持工单

**场景**：支持中心派工单给技术人员，等待反馈。

* **消息事件**：技术人员回复“已解决”。
* **定时器事件**：48 小时内无回复。
* **条件事件**：客户主动关闭工单。

👉 谁先发生，就走对应路径。

---

✅ **总结**：
事件型网关后只能跟这些“等待类事件”，因为它要“等结果”。在真实业务中，常见场景就是 **等待客户响应** 或 **等待超时处理**。

---

### Event based Gateway course example file

<Order handling (en).bpmn>
<Order handling (en).pdf>
<event_based_gateway1.png>
<event_based_gateway2.png>

---

## 循环与多实例 (Loops & Multi-instance)

在这个视频里，我们将讲解 **重复 (repetitions)**。

有时候做一次就够了，但有时候你需要重复。 一次又一次。
就像你在学习弹钢琴时，不断地反复练习。

---

### 🔁 循环 (Loops)

如果你想回到某个活动，可以使用 **网关 (Gateway)**。

举个例子：在 **合同谈判流程** 中，

* 如果谈判结果是合同签署 → 流程结束（合同已签署）。
* 如果没有达成协议 → 我们需要重复谈判，一次又一次。

这里有个问题：我们很难提前知道需要谈判几次。

在 BPMN 中，我们可以用 **循环标记 (Loop Marker)** 来表示这种情况。
这个标记你可能在音乐播放器上见过 —— 循环播放。

👉 在 BPMN 里，循环表示：

* **某个任务** 或 **子流程** 需要不断重复，直到满足某个条件。
* 比如：不断谈判，直到合同签署。

循环可以是：

* **标准循环 (Standard Loop)** → 直到某条件成立才结束。
* 次数不确定：可能 1 次、2 次、3 次，直到完成。

---

### 👥 多实例 (Multi-instance)

除了循环，还有另一种情况：**多实例活动 (Multi-instance Activities)**。

* 和循环不同，多实例是在**执行前就知道要重复多少次**。
* 可以用于任务 (Task) 或子流程 (Sub-process)。

👉 举例：HR 招聘流程

* 如果你收到 15 份简历 → 你就要检查 15 份。
* 这是预定义次数，所以用 **多实例**。

多实例有两种表现形式：

1. **普通多实例** → 三条竖线标记
2. **顺序多实例 (Sequential Multi-instance)** → 逐个顺序执行

在普通多实例里，可以并行执行：

* 例如，一个同事检查 3 份简历，另一个检查剩下的。
* 这样效率更高。

---

### 📚 诺贝尔奖提名流程的例子

<https://sparxsystems.com/resources/gallery/diagrams/business/bus-bpmn_business_process-nobel_prize_process.html>

我们可以用 **诺贝尔奖评选流程** 来展示循环和多实例的区别。

1. **发送提名表**

   * 需要发给固定数量的人（例如若干提名人）。
   * 这里使用 **多实例标记**（因为次数已知）。

2. **收集提名表**

   * 我们不知道会收到多少份（有些人可能不交）。
   * 所以这里使用 **循环标记**（直到收集到合适数量）。

3. **专家评审**

   * 如果需要专家协助 → 把候选名单发送给专家。
   * 专家数量已知，所以这里用 **多实例**。

4. **专家报告**

   * 有的专家可能没交报告。
   * 所以不能用多实例，而是用 **循环**（直到收到报告）。

5. **最后流程**

   * 选择最终候选人 → 提交推荐报告。
   * 诺贝尔大会讨论并宣布获奖者。
   * 由于可能有多个获奖者 → 使用多实例标记。
   * 最终以颁奖典礼结束流程。

---

### ✅ 总结

* **循环 (Loop)** → 重复直到某个条件满足（次数未知）
* **多实例 (Multi-instance)** → 执行多次，次数已知（可顺序或并行）

👉 最佳实践：
如果使用循环或多实例，最好加上 **Text Annotation (文字批注)** 来说明：

* 循环条件是什么？
* 多实例要执行多少次？

这样别人看流程时更清晰。

---
